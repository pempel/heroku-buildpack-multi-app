#!/usr/bin/env bash

indent() {
    sed -u 's/^/       /'
}

SCRIPT_NAME="heroku-buildpack-multiple-ruby-apps"
SCRIPT_DIR=`cd $(dirname $0); cd ..; pwd`
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
APP_DIR=$(cat ${ENV_DIR}/APP_DIR)

cd ${BUILD_DIR}

if [ ! -d "${APP_DIR}" ]; then
    echo "APP_DIR does not exist. Aborting" | indent
    exit 1
fi

find . -maxdepth 1 -type d ! -name ${APP_DIR} ! -name "." -exec rm -rf {} +
mv ${APP_DIR}/* .
rm -rf ${APP_DIR}

mkdir -p "${BUILD_DIR}/.profile.d/${SCRIPT_NAME}"
cp "${SCRIPT_DIR}/bin/export" "${BUILD_DIR}/.profile.d/${SCRIPT_NAME}/export"

echo "Copied the app from the ${APP_DIR} folder successfully" | indent
